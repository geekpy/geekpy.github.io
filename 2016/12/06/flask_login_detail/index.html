<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>使用Flask实现用户登陆认证的详细过程 | Geekpy's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Geekpy's Blog</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a><a href="/about" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><div class="wrapper"><div class="container post-header"><h1>使用Flask实现用户登陆认证的详细过程</h1></div></div><article><div class="container post"><p>本文旨在详细讲解用户登录的原理和过程，并通过Flask框架来完整实现整个登录过程</p>
<p>&lt;!--more--&gt;</p>
<h3>用户认证的原理</h3>
<p>在了解使用Flask来实现用户认证之前，我们首先要明白用户认证的原理。假设现在我们要自己去实现用户认证，需要做哪些事情呢？</p>
<ol>
<li>首先，用户要能够输入用户名和密码，所以需要网页和表单，用以实现用户输入和提交的过程。</li>
<li>用户提交了用户名和密码，我们就需要比对用户名，密码是否正确，而要想比对，首先我们的系统中就要有存储用户名，密码的地方，大多数后台系统会通过数据库来存储，但是实际上我们也可以简单的存储到文件当中。(为简明起见，本文将用户信息存储到json文件当中)</li>
<li>登录之后，我们需要维持用户登录状态，以便用户在访问特定网页的时候来判断用户是否已经登录，以及是否有权限访问改网页。这就需要有维护一个会话来保存用户的登录状态和用户信息。</li>
<li>从第三步我们也可以看出，如果我们的网页需要权限保护，那么当请求到来的时候，我们就首先要检查用户的信息，比如是否已经登录，是否有权限等，如果检查通过，那么在response的时候就会将相应网页回复给请求的用户，但是如果检查不通过，那么就需要返回错误信息。</li>
<li>在第二步，我们知道要将用户名和密码存储起来，但是如果只是简单的用明文存储用户名和密码，很容易被“有心人”盗取，从而造成用户信息泄露，那么我们实际上应当将用户信息尤其是密码做加密处理之后再存储比较安全。</li>
<li>用户登出</li>
</ol>
<h3>通过Flask以及相应的插件来实现登录过程</h3>
<p>接下来讲述如何通过Flask框架以及相应的插件来实现整个登录过程，需要用到的插件如下：</p>
<ul>
<li>flask-wtf</li>
<li>wtf</li>
<li>werkzeug</li>
<li>flask_login</li>
</ul>
<h4>使用flask-wtf和wtf来实现表单功能</h4>
<p>flask-wtf对wtf做了一些封装，不过有些东西还是要直接用wtf，比如StringField等。flask-wtf和wtf主要是用于建立html中的元素和Python中的类的对应关系，通过在Python代码中操作对应的类，对象等从而控制html中的元素。我们需要在python代码中使用flask-wtf和wtf来定义前端页面的表单（实际是定义一个表单类），再将对应的表单对象作为render_template函数的参数，传递给相应的template，之后Jinja模板引擎会将相应的template渲染成html文本，再作为http response返回给用户。</p>
<p>定义表单类示例代码：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># forms.py</span><br><span class="line">from flask_wtf import FlaskForm</span><br><span class="line">from wtforms import StringField, BooleanField, PasswordField</span><br><span class="line">from wtforms.validators import DataRequired</span><br><span class="line"></span><br><span class="line"># 定义的表单都需要继承自FlaskForm</span><br><span class="line">class LoginForm(FlaskForm):</span><br><span class="line">    # 域初始化时，第一个参数是设置label属性的</span><br><span class="line">    username = StringField(&apos;User Name&apos;, validators=[DataRequired()])</span><br><span class="line">    password = PasswordField(&apos;Password&apos;, validators=[DataRequired()])</span><br><span class="line">    remember_me = BooleanField(&apos;remember me&apos;, default=False)</span><br></pre></td></tr></table></figure></p>
<p>在wtf当中，每个域代表就是html中的元素，比如StringField代表的是&lt;input type=&quot;text&quot;&gt;元素，当然wtf的域还定义了一些特定功能，比如validators，可以通过validators来对这个域的数据做检查，详细请参考wtf教程。
对应的html模板可能如下login.html：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;layout.html&quot; %&#125;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Login Page&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;form action=&quot;&#123;&#123; url_for(&quot;login&quot;) &#125;&#125;&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">            User Name:&lt;br&gt;</span><br><span class="line">            &lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt;&lt;br&gt;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">            Password:&lt;/br&gt;</span><br><span class="line">            &lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;&lt;br&gt;</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">            &lt;input type=&quot;checkbox&quot; name=&quot;remember_me&quot;/&gt;Remember Me</span><br><span class="line">        &lt;/p&gt;</span><br><span class="line">            &#123;&#123; form.csrf_token &#125;&#125; </span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">&#123;% 这里\&#123;\&#123; form.csrf_token \&#125;\&#125;也可以使用&#123;&#123; form.hidden_tag() &#125;&#125;来替换i%&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时我们也可以使用form去定义模板，跟直接用html标签去定义效果是相同的，Jinja模板引擎会将对象、属性转化为对应的html标签，
相对应的template，如下login.html：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 模板的语法应当符合Jinja语法 --&gt;</span><br><span class="line">&lt;!-- extend from base layout --&gt;</span><br><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">  &lt;h1&gt;Sign In&lt;/h1&gt;</span><br><span class="line">  &lt;form action=&quot;&#123;&#123; url_for(&quot;login&quot;) &#125;&#125;&quot; method=&quot;post&quot; name=&quot;login&quot;&gt;</span><br><span class="line">      &#123;&#123; form.csrf_token &#125;&#125;</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">          &#123;&#123; form.username.label &#125;&#125;&lt;br&gt;</span><br><span class="line">          &#123;&#123; form.username(size=80) &#125;&#125;&lt;br&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">          &#123;&#123; form.password.label &#125;&#125;&lt;br&gt;</span><br><span class="line">          &lt;!-- 我们可以传递input标签的属性，这里传递的是size属性 --&gt;</span><br><span class="line">          &#123;&#123; form.password(size=80) &#125;&#125;&lt;br&gt;</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">      &lt;p&gt;&#123;&#123; form.remember_me &#125;&#125; Remember Me&lt;/p&gt;</span><br><span class="line">      &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Sign In&quot;&gt;&lt;/p&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在我们需要在view中定义相应的路由，并将相应的登录界面展示给用户。
简单起见，将view的相关路由定义放在主程序当中
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># app.py</span><br><span class="line">@app.route(&apos;/login&apos;)</span><br><span class="line">def login():</span><br><span class="line">    form = LoginForm()</span><br><span class="line">    return render_template(&apos;login.html&apos;, title=&quot;Sign In&quot;, form=form)</span><br></pre></td></tr></table></figure></p>
<p>这里简单起见，当用户请求'/login'路由时，直接返回login.html网页，注意这里的html网页是经过Jinja模板引擎将相应的模板转换后的html网页。
至此，如果我们把以上代码整合到flask当中，就应该能够看到相应的登录界面了，那么当用户提交之后，我们应当怎样存储呢？这里我们暂时先不用数据库这样复杂的工具存储，先简单地存为文件。接下来就看下如何去存储。</p>
<h4>加密和存储</h4>
<p>我们可以首先定义一个User类，用于处理与用户相关的操作，包括存储和验证等。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"># models.py</span><br><span class="line"></span><br><span class="line">from werkzeug.security import generate_password_hash</span><br><span class="line">from werkzeug.security import check_password_hash</span><br><span class="line">from flask_login import UserMixin</span><br><span class="line">import json</span><br><span class="line">import uuid</span><br><span class="line"></span><br><span class="line"># define profile.json constant, the file is used to</span><br><span class="line"># save user name and password_hash</span><br><span class="line">PROFILE_FILE = &quot;profiles.json&quot;</span><br><span class="line"></span><br><span class="line">class User(UserMixin):</span><br><span class="line">    def __init__(self, username):</span><br><span class="line">        self.username = username</span><br><span class="line">        self.id = self.get_id()</span><br><span class="line"></span><br><span class="line">    @property</span><br><span class="line">    def password(self):</span><br><span class="line">        raise AttributeError(&apos;password is not a readable attribute&apos;)</span><br><span class="line"></span><br><span class="line">    @password.setter</span><br><span class="line">    def password(self, password):</span><br><span class="line">        &quot;&quot;&quot;save user name, id and password hash to json file&quot;&quot;&quot;</span><br><span class="line">        self.password_hash = generate_password_hash(password)</span><br><span class="line">        with open(PROFILE_FILE, &apos;w+&apos;) as f:</span><br><span class="line">            try:</span><br><span class="line">                profiles = json.load(f)</span><br><span class="line">            except ValueError:</span><br><span class="line">                profiles = &#123;&#125;</span><br><span class="line">            profiles[self.username] = [self.password_hash,</span><br><span class="line">                                       self.id]</span><br><span class="line">            f.write(json.dumps(profiles))</span><br><span class="line"></span><br><span class="line">    def verify_password(self, password):</span><br><span class="line">        password_hash = self.get_password_hash()</span><br><span class="line">        if password_hash is None:</span><br><span class="line">            return False</span><br><span class="line">        return check_password_hash(self.password_hash, password)</span><br><span class="line"></span><br><span class="line">    def get_password_hash(self):</span><br><span class="line">        &quot;&quot;&quot;try to get password hash from file.</span><br><span class="line"></span><br><span class="line">        :return password_hash: if the there is corresponding user in</span><br><span class="line">                the file, return password hash.</span><br><span class="line">                None: if there is no corresponding user, return None.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        try:</span><br><span class="line">            with open(PROFILE_FILE) as f:</span><br><span class="line">                user_profiles = json.load(f)</span><br><span class="line">                user_info = user_profiles.get(self.username, None)</span><br><span class="line">                if user_info is not None:</span><br><span class="line">                    return user_info[0]</span><br><span class="line">        except IOError:</span><br><span class="line">            return None</span><br><span class="line">        except ValueError:</span><br><span class="line">            return None</span><br><span class="line">        return None</span><br><span class="line"></span><br><span class="line">    def get_id(self):</span><br><span class="line">        &quot;&quot;&quot;get user id from profile file, if not exist, it will</span><br><span class="line">        generate a uuid for the user.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if self.username is not None:</span><br><span class="line">            try:</span><br><span class="line">                with open(PROFILE_FILE) as f:</span><br><span class="line">                    user_profiles = json.load(f)</span><br><span class="line">                    if self.username in user_profiles:</span><br><span class="line">                        return user_profiles[self.username][1]</span><br><span class="line">            except IOError:</span><br><span class="line">                pass</span><br><span class="line">            except ValueError:</span><br><span class="line">                pass</span><br><span class="line">        return unicode(uuid.uuid4())</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def get(user_id):</span><br><span class="line">        &quot;&quot;&quot;try to return user_id corresponding User object.</span><br><span class="line">        This method is used by load_user callback function</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        if not user_id:</span><br><span class="line">            return None</span><br><span class="line">        try:</span><br><span class="line">            with open(PROFILE_FILE) as f:</span><br><span class="line">                user_profiles = json.load(f)</span><br><span class="line">                for user_name, profile in user_profiles.iteritems():</span><br><span class="line">                    if profile[1] == user_id:</span><br><span class="line">                        return User(user_name)</span><br><span class="line">        except:</span><br><span class="line">            return None</span><br><span class="line">        return None</span><br></pre></td></tr></table></figure></p>
<ul>
<li>User类需要继承flask-login中的UserMixin类，用于实现相应的用户会话管理。</li>
<li>这里我们是直接存储用户信息到一个json文件&quot;profiles.json&quot;</li>
<li>我们并不直接存储密码，而是存储加密后的hash值，在这里我们使用了werkzeug.security包中的generate_password_hash函数来进行加密，由于此函数默认使用了sha1算法，并添加了长度为8的盐值，所以还是相当安全的。一般用途的话也就够用了。</li>
<li>验证password的时候，我们需要使用werkzeug.security包中的check_password_hash函数来验证密码</li>
<li>get_id是UserMixin类中就有的method，在这我们需要overwrite这个method。在json文件中没有对应的user id时，可以使用uuid.uuid4()生成一个用户唯一id</li>
</ul>
<p>至此，我们就实现了第二步和第五步，接下来要看第三步，如何去维护一个session</p>
<h4>维护用户session</h4>
<p>先看下代码，这里把相应代码也放入到app.py当中
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">from forms import LoginForm</span><br><span class="line">from flask_wtf.csrf import CsrfProtect</span><br><span class="line">from model import User</span><br><span class="line">from flask_login import login_user, login_required</span><br><span class="line">from flask_login import LoginManager, current_user</span><br><span class="line">from flask_login import logout_user</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(24)</span><br><span class="line"></span><br><span class="line"># use login manager to manage session</span><br><span class="line">login_manager = LoginManager()</span><br><span class="line">login_manager.session_protection = &apos;strong&apos;</span><br><span class="line">login_manager.login_view = &apos;login&apos;</span><br><span class="line">login_manager.init_app(app=app)</span><br><span class="line"></span><br><span class="line"># 这个callback函数用于reload User object，根据session中存储的user id</span><br><span class="line">@login_manager.user_loader</span><br><span class="line">def load_user(user_id):</span><br><span class="line">    return User.get(user_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># csrf protection</span><br><span class="line">csrf = CsrfProtect()</span><br><span class="line">csrf.init_app(app)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/login&apos;)</span><br><span class="line">def login():</span><br><span class="line">    form = LoginForm()</span><br><span class="line">    if form.validate_on_submit():</span><br><span class="line">        user_name = request.form.get(&apos;username&apos;, None)</span><br><span class="line">        password = request.form.get(&apos;password&apos;, None)</span><br><span class="line">        remember_me = request.form.get(&apos;remember_me&apos;, False)</span><br><span class="line">        user = User(user_name)</span><br><span class="line">        if user.verify_password(password):</span><br><span class="line">            login_user(user, remember=remember_me)</span><br><span class="line">            return redirect(request.args.get(&apos;next&apos;) or url_for(&apos;main&apos;))</span><br><span class="line">    return render_template(&apos;login.html&apos;, title=&quot;Sign In&quot;, form=form)</span><br></pre></td></tr></table></figure></p>
<ul>
<li>维护用户的会话，关键就在这个LoginManager对象。</li>
<li>必须实现这个load_user callback函数，用以reload user object</li>
<li>当密码验证通过后，使用login_user()函数来登录用户，这时用户在会话中的状态就是登录状态了</li>
</ul>
<h4>受保护网页</h4>
<p>保护特定网页，只需要对特定路由加一个装饰器就可以，如下
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># app.py</span><br><span class="line"></span><br><span class="line"># ...</span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">@app.route(&apos;/main&apos;)</span><br><span class="line">@login_required</span><br><span class="line">def main():</span><br><span class="line">    return render_template(</span><br><span class="line">        &apos;main.html&apos;, username=current_user.username)</span><br><span class="line"># ...</span><br></pre></td></tr></table></figure></p>
<ul>
<li>current_user保存的就是当前用户的信息，实质上是一个User对象，所以我们直接调用其属性, 例如这里我们要给模板传一个username的参数，就可以直接用current_user.username</li>
<li>使用@login_required来标识改路由需要登录用户，非登录用户会被重定向到'/login'路由(这个就是由login_manager.login_view = 'login' 语句来指定的)</li>
</ul>
<h4>用户登出</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># app.py</span><br><span class="line"></span><br><span class="line"># ...</span><br><span class="line">@app.route(&apos;/logout&apos;)</span><br><span class="line">@login_required</span><br><span class="line">def logout():</span><br><span class="line">    logout_user()</span><br><span class="line">    return redirect(url_for(&apos;login&apos;))</span><br><span class="line"># ...</span><br></pre></td></tr></table></figure></p>
<p>至此，我们就实现了一个完整的登陆和登出的过程。</p>
<p>另外我们可能还需要其它辅助的功能，诸如发送确认邮件，密码重置，权限分级管理等，这些功能都可以通过flask及其插件来完成，这个大家可以自己探索下啦！</p>
</div><div class="container"><hr><div class="comment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/npm/valine@1.1.6/dist/Valine.min.js"></script>
<script type="text/javascript">
var leancloud_appid = 'OCjgmQiFa9gpVkDabM6KTb8g-gzGzoHsz';
var leancloud_appkey = 'Ie7XE2V6spB6Q6C1W2GU9drV';
var valine_url = 'http://yoursite.com/2016/12/06/flask_login_detail/';
var valine_notify = false;
var valine_verify = false;
var valine_placeholder = '';
new Valine({
         av: AV, // source from av-min.js
         el: '.comment' ,
         notify: valine_notify,
         verify: valine_verify,
         app_id: leancloud_appid,
         app_key: leancloud_appkey,
         placeholder: valine_placeholder,
         path: valine_url
     });
</script></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:rebor.liu@gmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/geekpy" target="_blank"><i class="fa fa-github"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">geekpy</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>